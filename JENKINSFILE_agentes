pipeline {
   agent any
   options { skipDefaultCheckout(true) }

   stages {
      stage('Get Code') {
        agent {label 'agente1'}
        steps {
            checkout scmGit(
               branches: [[ name: 'develop' ]],
               extensions: [ cloneOption( shallow: true, depth: 1 )],
               userRemoteConfigs: [[ url: 'https://github.com/Gaizka-Dev/helloworld.git' ]]
            )
            sh 'whoami'
            echo WORKSPACE
            sh 'pwd && ls -lah'
            stash name:'code', includes:'**'
        }
      }

      stage('Static') {
         agent {label 'agente2'}
         steps {
            unstash name:'code'
            sh 'whoami'
            echo WORKSPACE
            sh 'flake8 --exit-zero --format=pylint app > flake8.out'
         //    recordIssues qualityGates: 
         //       [[ threshold: 8.0, type: 'TOTAL', unsetable: true], [criticality: 'ERROR', integerThreshold: 9, threshold: 9.0, type: 'TOTAL']], 
         //       sourceCodeRetention: 'LAST_BUILD', 
         //       tools: [flake8(name: 'Flake8', pattern: 'flake8.out')]
         }
      }

      stage('Tests') {
         parallel {
            stage('Unit') {
               agent {label 'agente3'}
               steps {
                  unstash name:'code'
                  sh 'whoami'
                  echo WORKSPACE
                  sh '''
                     export PYTHONPATH=$PYTHONPATH:$WORKSPACE
                     pytest --junitxml=result-unit.xml test/unit
                  '''
                  stash name:'unit-res', includes:'result-unit.xml'
               }
            }
            stage('Rest') {
               // agent {label 'SBC'}
               agent {label 'agente3'}
               steps {
                  sh 'whoami'
                  echo WORKSPACE
                  catchError(buildResult: 'SUCCESS', stageResult: 'UNSTABLE') {
                     unstash name:'code'
                     sh 'docker ps --all --quiet --filter name=wiremock | xargs --no-run-if-empty docker rm --force'
                     sh '''
                        flask --app ./app/api.py run &
                        docker run \
                           --detach \
                           --rm \
                           --name wiremock \
                           --publish 9090:8080 \
                           --volume $PWD/test/wiremock/:/home/wiremock/:ro \
                           wiremock/wiremock:latest
                     '''
                     sh 'ping -c5 localhost' // Hacemos ping para darle tiempo a que se levanten flask y wiremork en docker
                     sh 'pytest --junitxml=result-rest.xml test/rest'
                     stash name:'rest-res', includes:'result-rest.xml'
                  }
               }   
            }  
         }
      }

      stage('Cobertura') {
         agent {label 'agente1'}
         steps {
            unstash name:'code'
            sh 'whoami'
            echo WORKSPACE
            sh 'ls -lah && pwd'
            sh '''
                export PYTHONPATH=$PYTHONPATH:$WORKSPACE
                coverage run --branch --source=app --omit=app/__init__.py,app/api.py -m pytest test/unit 
                coverage xml
            '''
            recordCoverage qualityGates: [[criticality: 'NOTE', integerThreshold: 85, metric: 'LINE', threshold: 85.0], [criticality: 'ERROR', integerThreshold: 60, metric: 'LINE', threshold: 60.0], [criticality: 'NOTE', integerThreshold: 80, metric: 'BRANCH', threshold: 80.0]], tools: [[parser: 'COBERTURA', pattern: 'coverage.xml']]
        }
      }

      stage('Seguridad') {
         steps {
            sh 'bandit --exit-zero -r . -f custom -o bandit.out --msg-template "{abspath}:{line}: [{test_id}] {msg}"'
            recordIssues minimumSeverity: 'HIGH', qualityGates: [[criticality: 'ERROR', integerThreshold: 8, threshold: 8.0, type: 'TOTAL']], sourceCodeRetention: 'LAST_BUILD', tools: [pyLint(name: 'Bandit', pattern: 'bandit.out')]
         }
      }

      stage('Performance') {
         steps {
            unstash name:'code'
            sh 'flask --app ./app/api.py run &'
            sh "/home/gka/Downloads/apache-jmeter-5.6.3/bin/jmeter.sh -n -t ${WORKSPACE}/test/jmeter/flask.jmx -l flask.jtl"
            // sh '/home/gka/Downloads/apache-jmeter-5.6.3/bin/jmeter.sh -n -t test/jmeter/flask.jmx -l flask.jtl'
            perfReport filterRegex: '', showTrendGraphs: true, sourceDataFiles: 'flask.jtl'
         }
      }

      stage('Results') {
         agent {label 'agente3'}
         steps {
            unstash name:'unit-res'
            sleep(5)
            unstash name:'rest-res'
            junit 'result*.xml'
         }
      }
   }

   post {
      cleanup {
         agent {label 'agente3'}
         script {
            sh 'docker ps --all --quiet --filter name=wiremock | xargs --no-run-if-empty docker rm --force'
         }
      }
   }
}
